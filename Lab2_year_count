id: 02_postgres_taxi
namespace: zoomcamp
description: |
  The CSV Data used in the course: https://github.com/DataTalksClub/nyc-tlc-data/releases

inputs:
  - id: taxi
    type: SELECT
    displayName: "Taxi Type"
    values:
      - yellow
      - green
    defaults: yellow
  - id: year
    type: SELECT
    displayName: "Year"
    values:
      - "2019"
      - "2020"
      - "2021"
    defaults: "2019"

tasks:
  - id: download_and_sum
    type: io.kestra.plugin.scripts.shell.Commands
    containerImage: alpine:3.17
    outputFiles:
      - result.txt
    commands:
      - |
        set -e
        # Устанавливаем curl, так как он отсутствует в базовом образе alpine
        apk add --no-cache curl
        total=0
        # Перебираем месяцы явно, чтобы избежать проблем с brace expansion
        for month in 01 02 03 04 05 06 07 08 09 10 11 12; do
          file="{{ inputs.taxi }}_tripdata_{{ inputs.year }}-${month}.csv"
          echo "Downloading file: $file" >&2
          # Скачиваем архив с GitHub, распаковываем и сохраняем как файл
          curl -sL "https://github.com/DataTalksClub/nyc-tlc-data/releases/download/{{ inputs.taxi }}/$file.gz" | gunzip > "$file"
          # Считаем количество строк без заголовка (начиная со второй строки)
          count=$(tail -n +2 "$file" | wc -l)
          echo "Count for $file: $count" >&2
          total=$(( total + count ))
        done
        # Итоговая сумма записывается в файл result.txt, который затем захватывается как output
        echo $total > result.txt
